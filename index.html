<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”å‘å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .upload-box:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .upload-box.has-file {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            font-size: 1.1em;
            color: #555;
            margin-bottom: 10px;
        }

        .upload-box.has-file .upload-label {
            color: #27ae60;
        }

        .file-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .process-btn {
            display: block;
            width: 200px;
            margin: 0 auto;
            padding: 15px 30px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .process-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .export-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .export-btn:hover {
            background: #219a52;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        /* Column-specific width classes */
        .col-rank { width: 60px; min-width: 60px; }
        .col-name { width: 120px; min-width: 120px; }
        .col-overdue-ratio { width: 110px; min-width: 110px; }
        .col-overdue-days { width: 110px; min-width: 110px; }
        .col-work-days { width: 110px; min-width: 110px; }
        .col-score { width: 90px; min-width: 90px; }
        .col-grade { width: 80px; min-width: 80px; }
        .col-explanation { min-width: 500px; width: auto; }

        .results-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .view-btn:hover {
            background: #f8f9fa;
        }

        .view-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* åˆ†ææŠ¥å‘Šæ ·å¼ */
        .analysis-report {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .report-header h1 {
            font-size: 2em;
            margin: 0;
        }

        .analysis-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .analysis-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .stats-grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stats-label {
            color: #666;
            font-size: 0.9em;
        }

        .grade-bars {
            display: grid;
            gap: 10px;
        }

        .grade-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grade-label {
            min-width: 60px;
            font-weight: bold;
        }

        .grade-S { color: #2ecc71; }
        .grade-A { color: #3498db; }
        .grade-B { color: #f39c12; }
        .grade-C { color: #e67e22; }
        .grade-D { color: #e74c3c; }

        .progress-bar {
            flex: 1;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-fill.grade-S { background: #2ecc71; }
        .progress-fill.grade-A { background: #3498db; }
        .progress-fill.grade-B { background: #f39c12; }
        .progress-fill.grade-C { background: #e67e22; }
        .progress-fill.grade-D { background: #e74c3c; }

        .grade-percentage {
            min-width: 50px;
            text-align: right;
            font-size: 0.9em;
            color: #666;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
        }

        .analysis-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-item.highlight {
            border-left: 4px solid #2ecc71;
        }

        .analysis-item.lowlight {
            border-left: 4px solid #e74c3c;
        }

        .analysis-item.review {
            border-left: 4px solid #f39c12;
        }

        .employee-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .employee-score {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .employee-explanation {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .suggestions-list {
            list-style: none;
            padding: 0;
        }

        .suggestion-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #3498db;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .grade {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            min-width: 30px;
            display: inline-block;
        }

        .grade-S { background: #2ecc71; color: white; }
        .grade-A { background: #3498db; color: white; }
        .grade-B { background: #f39c12; color: white; }
        .grade-C { background: #e67e22; color: white; }
        .grade-D { background: #e74c3c; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .stat-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 14px;
        }

        .stat-value {
            font-weight: 700;
            color: #212529;
            font-size: 16px;
        }

        /* ç´§å‡‘å‹ç»Ÿè®¡ç½‘æ ¼ */
        .stats-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .stats-compact .stat-item {
            margin-bottom: 0;
            padding: 10px 12px;
        }

        .stats-compact .stat-label {
            font-size: 13px;
        }

        .stats-compact .stat-value {
            font-size: 15px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .stat-value.good {
            color: #27ae60;
        }

        .stat-value.warning {
            color: #f39c12;
        }

        .stat-value.danger {
            color: #e74c3c;
        }

        .stat-value.info {
            color: #3498db;
        }

        /* åˆ†æåŒºå—ä¼˜åŒ– */
        .analysis-section {
            margin-bottom: 24px;
        }

        .analysis-section h3 {
            margin-bottom: 16px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        /* å°å‹æ ‡ç­¾ */
        .stat-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .stat-tag.good {
            background: #d4edda;
            color: #155724;
        }

        .stat-tag.warning {
            background: #fff3cd;
            color: #856404;
        }

        .stat-tag.danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* è¡ŒåŠ¨å»ºè®®æ ·å¼ */
        .action-item {
            background: #ffffff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .action-item.critical {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .action-item.important {
            border-left-color: #f39c12;
            background: #fffbf0;
        }

        .action-item.recommendation {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .action-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .action-description {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.4;
        }

        .action-metric {
            display: inline-block;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
            margin-right: 6px;
        }

        /* é—®é¢˜é«˜äº®æ ·å¼ */
        .problem-highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .problem-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 4px;
        }

        .problem-value {
            font-size: 18px;
            font-weight: 700;
            color: #d68910;
        }

        /* æ”¹è¿›å»ºè®®åŒºå— */
        .suggestions-block {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .suggestion-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .suggestion-icon {
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .suggestion-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            color: #495057;
        }

        .suggestion-text strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 2px;
        }

        /* ç­‰çº§åˆ†å¸ƒæ ·å¼ */
        .grade-overview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .grade-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .grade-summary-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid;
            background: white;
        }

        .grade-summary-item.grade-S {
            border-color: #27ae60;
            color: #27ae60;
        }

        .grade-summary-item.grade-A {
            border-color: #3498db;
            color: #3498db;
        }

        .grade-summary-item.grade-B {
            border-color: #f39c12;
            color: #f39c12;
        }

        .grade-summary-item.grade-C {
            border-color: #e67e22;
            color: #e67e22;
        }

        .grade-summary-item.grade-D {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .grade-count-number {
            font-size: 24px;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .grade-count-label {
            font-size: 14px;
            font-weight: 500;
        }

        .grade-bars {
            margin-top: 20px;
        }

        .grade-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .grade-bar-label {
            width: 60px;
            font-weight: 600;
            font-size: 14px;
        }

        .grade-bar-container {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            margin: 0 15px;
            overflow: hidden;
            position: relative;
        }

        .grade-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .grade-bar-fill.grade-S {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .grade-bar-fill.grade-A {
            background: linear-gradient(135deg, #3498db, #5dade2);
        }

        .grade-bar-fill.grade-B {
            background: linear-gradient(135deg, #f39c12, #f1c40f);
        }

        .grade-bar-fill.grade-C {
            background: linear-gradient(135deg, #e67e22, #d68910);
        }

        .grade-bar-fill.grade-D {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .grade-bar-percentage {
            width: 50px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .explanation {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .explanation-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            text-align: left;
            line-height: 1.3;
        }

        .explanation-column {
            padding: 6px 8px;
            border-radius: 5px;
            background: #f8f9fa;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .explanation-column:hover {
            background: #e9ecef;
            white-space: normal;
            overflow: visible;
            position: relative;
            z-index: 1;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .upload-section,
            .results-section {
                padding: 20px;
            }

            .results-table {
                font-size: 0.8em;
            }

            .results-table th,
            .results-table td {
                padding: 6px 4px;
            }

            .col-name,
            .col-overdue-ratio,
            .col-overdue-days,
            .col-work-days,
            .col-score,
            .col-grade {
                min-width: 80px;
            }

            .col-explanation {
                min-width: 300px;
            }

            .explanation-columns {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .explanation-column {
                padding: 3px 4px;
                font-size: 0.8em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.3;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 8px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .upload-section,
            .results-section {
                padding: 15px;
            }

            .results-table {
                font-size: 0.7em;
            }

            .results-table th,
            .results-table td {
                padding: 4px 2px;
            }

            .col-name,
            .col-overdue-ratio,
            .col-overdue-days,
            .col-work-days,
            .col-score,
            .col-grade {
                min-width: 60px;
            }

            .col-explanation {
                min-width: 250px;
            }

            .explanation-columns {
                grid-template-columns: 1fr;
                gap: 3px;
            }

            .explanation-column {
                padding: 2px 3px;
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç ”å‘å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†ç³»ç»Ÿ</h1>
            <p>åŸºäºPythonè¯„åˆ†ç®—æ³•çš„ç½‘é¡µç‰ˆ - æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œå®æ—¶åˆ†æ</p>
        </div>

        <div class="upload-section">
            <div class="upload-grid">
                <div class="upload-box" id="overdue-box">
                    <label for="overdue-file" class="upload-label">
                        ğŸ“Š é€¾æœŸæ¯”ä¾‹æ•°æ®
                    </label>
                    <input type="file" id="overdue-file" accept=".data,.txt" onchange="handleFileSelect('overdue', this)">
                    <div class="file-info" id="overdue-info">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-box" id="mean-overdue-box">
                    <label for="mean-overdue-file" class="upload-label">
                        â° é€¾æœŸå¤©æ•°æ•°æ®
                    </label>
                    <input type="file" id="mean-overdue-file" accept=".data,.txt" onchange="handleFileSelect('mean-overdue', this)">
                    <div class="file-info" id="mean-overdue-info">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-box" id="days-box">
                    <label for="days-file" class="upload-label">
                        ğŸ’¼ å·¥ä½œäººå¤©æ•°æ®
                    </label>
                    <input type="file" id="days-file" accept=".data,.txt" onchange="handleFileSelect('days', this)">
                    <div class="file-info" id="days-info">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                </div>
            </div>

            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨å¤„ç†æ•°æ®...</div>
            </div>

            <button class="process-btn" id="process-btn" onclick="processFiles()" disabled>
                å¼€å§‹åˆ†æ
            </button>
        </div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <h2>è¯„åˆ†ç»“æœ</h2>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('table')" id="table-view-btn">è¡¨æ ¼è§†å›¾</button>
                    <button class="view-btn" onclick="switchView('analysis')" id="analysis-view-btn">åˆ†ææŠ¥å‘Š</button>
                </div>
                <button class="export-btn" onclick="exportToCSV()">å¯¼å‡ºCSV</button>
            </div>

            <div class="results-table-container">
                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th class="col-rank">æ’å</th>
                            <th class="col-name">å§“å</th>
                            <th class="col-overdue-ratio">é€¾æœŸæ¯”ä¾‹</th>
                            <th class="col-overdue-days">é€¾æœŸå¤©æ•°</th>
                            <th class="col-work-days">å·¥ä½œäººå¤©</th>
                            <th class="col-score">ç»¼åˆå¾—åˆ†</th>
                            <th class="col-grade">ç­‰çº§</th>
                            <th class="col-explanation">è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
            </div>

            <div class="stats-grid" id="stats-grid">
            </div>

            <!-- åˆ†ææŠ¥å‘Šå®¹å™¨ -->
            <div class="analysis-report" id="analysis-report" style="display: none;">
                <div class="report-header">
                    <h1>ç ”å‘å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†åˆ†ææŠ¥å‘Š (ä¼˜åŒ–ç‰ˆv2.3)</h1>
                </div>

                <!-- åŸºç¡€ç»Ÿè®¡ -->
                <div class="analysis-section">
                    <h3>ğŸ“Š åŸºç¡€ç»Ÿè®¡</h3>
                    <div class="stats-overview" id="stats-overview">
                        <div class="stats-compact">
                            <div class="stat-item">
                                <span class="stat-label">æ€»è¯„ä¼°äººæ•°</span>
                                <span class="stat-value" id="total-people">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">å¹³å‡ç»¼åˆå¾—åˆ†</span>
                                <span class="stat-value" id="avg-score">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">å¾—åˆ†ä¸­ä½æ•°</span>
                                <span class="stat-value" id="median-score">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">åˆ†æ•°åŒºé—´</span>
                                <span class="stat-value" id="score-range">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç­‰çº§åˆ†å¸ƒ -->
                <div class="analysis-section">
                    <h3>ğŸ† ç­‰çº§åˆ†å¸ƒ (Sâ‰¥85, Aâ‰¥70, Bâ‰¥55, Câ‰¥40)</h3>
                    <div class="grade-distribution" id="grade-distribution">
                        <div class="grade-overview">
                            <div class="grade-summary" id="grade-summary">
                                <!-- æ€»ä½“ç»Ÿè®¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                            <div class="grade-bars" id="grade-bars">
                                <!-- ç­‰çº§æ¡å½¢å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é€¾æœŸé—®é¢˜åˆ†æ -->
                <div class="analysis-section">
                    <h3>â° é€¾æœŸé—®é¢˜åˆ†æ</h3>
                    <div class="overdue-analysis" id="overdue-analysis">
                        <div class="stats-compact">
                            <div class="stat-item">
                                <span class="stat-label">å¹³å‡é€¾æœŸæ¯”ä¾‹</span>
                                <span class="stat-value" id="avg-overdue-ratio">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">å¹³å‡é€¾æœŸå¤©æ•°</span>
                                <span class="stat-value" id="avg-overdue-days">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ä¸¥é‡é€¾æœŸ(>50%)</span>
                                <span class="stat-value" id="serious-overdue">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">é•¿æœŸé€¾æœŸ(>5å¤©)</span>
                                <span class="stat-value" id="long-overdue">-</span>
                            </div>
                        </div>
                        <!-- é—®é¢˜é«˜äº®åŒºåŸŸ -->
                        <div id="overdue-problems" style="margin-top: 16px;">
                            <!-- åŠ¨æ€ç”Ÿæˆé—®é¢˜é«˜äº® -->
                        </div>
                    </div>
                </div>

                <!-- å·¥ä½œé‡åˆ†æ -->
                <div class="analysis-section">
                    <h3>ğŸ’¼ å·¥ä½œé‡åˆ†æ (æ–°è¯„åˆ†æ ‡å‡†ï¼šäººå¤©è¶Šå¤šè¶Šå¥½)</h3>
                    <div class="workload-analysis" id="workload-analysis">
                        <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
                        <div class="stats-compact" style="margin-bottom: 16px;">
                            <div class="stat-item">
                                <span class="stat-label">å¹³å‡å·¥ä½œäººå¤©</span>
                                <span class="stat-value" id="avg-work-days">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">äººå¤©ä¸­ä½æ•°</span>
                                <span class="stat-value" id="median-work-days">-</span>
                            </div>
                        </div>
                        <!-- åˆ†å¸ƒæƒ…å†µ -->
                        <div class="stats-compact">
                            <div class="stat-item">
                                <span class="stat-label">å·¥ä½œé‡ä¸è¶³(<8äººå¤©)</span>
                                <span class="stat-value" id="insufficient-work">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ç†æƒ³åŒºé—´(8-10äººå¤©)</span>
                                <span class="stat-value" id="ideal-work">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ä¼˜ç§€è¡¨ç°(10-15äººå¤©)</span>
                                <span class="stat-value" id="excellent-work">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è¶…é«˜äº§å‡º(>15äººå¤©)</span>
                                <span class="stat-value" id="high-work">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Highlightå€™é€‰ -->
                <div class="analysis-section">
                    <h3>ğŸŒŸ Highlightå€™é€‰ (Sçº§ â‰¥85åˆ†)</h3>
                    <div class="highlight-candidates" id="highlight-employees">
                    </div>
                </div>

                <!-- Lowlightéœ€å…³æ³¨ -->
                <div class="analysis-section">
                    <h3>âš ï¸ Lowlightéœ€å…³æ³¨ (Dçº§ <40åˆ†)</h3>
                    <div class="lowlight-concerns" id="lowlight-employees">
                    </div>
                </div>

                <!-- éœ€æ ¸å®äººå¤©è®°å½• -->
                <div class="analysis-section">
                    <h3>ğŸ” éœ€æ ¸å®äººå¤©è®°å½• (>15äººå¤©)</h3>
                    <div class="review-needed" id="review-employees">
                    </div>
                </div>

                <!-- å›¢é˜Ÿæ”¹è¿›å»ºè®® -->
                <div class="analysis-section">
                    <h3>ğŸ’¡ å›¢é˜Ÿæ”¹è¿›å»ºè®®</h3>
                    <div class="suggestions-block">
                        <div class="improvement-suggestions" id="team-suggestions">
                            <!-- å»ºè®®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileData = {
            overdue: null,
            meanOverdue: null,
            days: null
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(type, input) {
            const file = input.files[0];
            if (!file) return;

            const box = document.getElementById(type + '-box');
            const info = document.getElementById(type + '-info');

            box.classList.add('has-file');
            info.textContent = `å·²é€‰æ‹©: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                fileData[type === 'mean-overdue' ? 'meanOverdue' : type] = e.target.result;
                checkAllFilesLoaded();
            };
            reader.readAsText(file, 'UTF-8');
        }

        // æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å·²åŠ è½½
        function checkAllFilesLoaded() {
            const btn = document.getElementById('process-btn');
            if (fileData.overdue && fileData.meanOverdue && fileData.days) {
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹åˆ†æ';
            } else {
                btn.disabled = true;
                btn.textContent = 'è¯·ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // æ•°æ®è§£æå™¨
        class DataParser {
            static parseOverdueData(content) {
                const data = {};
                const lines = content.split('\n').filter(line => line.trim());

                console.log('Overdue data lines:', lines.length);

                for (let i = 0; i < lines.length; i += 3) {
                    if (i + 2 < lines.length) {
                        const name = lines[i].trim();
                        const ratioStr = lines[i + 1].trim();
                        const ratio = parseFloat(ratioStr.replace('%', ''));
                        if (!isNaN(ratio) && name) {
                            data[name] = ratio;
                            console.log(`Overdue: ${name} = ${ratio}%`);
                        }
                    }
                }
                console.log('Overdue data parsed:', Object.keys(data).length, 'entries');
                return data;
            }

            static parseMeanOverdueData(content) {
                const data = {};
                const lines = content.split('\n').filter(line => line.trim());

                console.log('Mean overdue data lines:', lines.length);

                for (let i = 0; i < lines.length; i += 3) {
                    if (i + 2 < lines.length) {
                        const name = lines[i].trim();
                        const days = parseFloat(lines[i + 1].trim());
                        if (!isNaN(days) && name) {
                            data[name] = days;
                            console.log(`Mean overdue: ${name} = ${days} days`);
                        }
                    }
                }
                console.log('Mean overdue data parsed:', Object.keys(data).length, 'entries');
                return data;
            }

            static parseDaysData(content) {
                const data = {};
                const lines = content.split('\n').filter(line => line.trim());

                console.log('Days data lines:', lines.length);

                for (let i = 0; i < lines.length; i += 5) {
                    if (i + 4 < lines.length) {
                        const name = lines[i].trim();
                        const workDays = parseFloat(lines[i + 1].trim());
                        if (!isNaN(workDays) && name) {
                            data[name] = workDays;
                            console.log(`Days: ${name} = ${workDays} work days`);
                        }
                    }
                }
                console.log('Days data parsed:', Object.keys(data).length, 'entries');
                return data;
            }

            static validateData(overdueData, meanOverdueData, daysData) {
                if (!overdueData || !meanOverdueData || !daysData) {
                    return { valid: false, message: "å­˜åœ¨ç©ºæ•°æ®é›†" };
                }

                console.log('Data validation:');
                console.log('- Overdue entries:', Object.keys(overdueData).length);
                console.log('- Mean overdue entries:', Object.keys(meanOverdueData).length);
                console.log('- Days entries:', Object.keys(daysData).length);

                const overdueNames = new Set(Object.keys(overdueData));
                const meanOverdueNames = new Set(Object.keys(meanOverdueData));
                const daysNames = new Set(Object.keys(daysData));

                const commonNames = new Set([...overdueNames].filter(name =>
                    meanOverdueNames.has(name) && daysNames.has(name)
                ));

                console.log('- Common names:', commonNames.size);
                console.log('- Names in all three datasets:', Array.from(commonNames).sort());

                if (commonNames.size === 0) {
                    return { valid: false, message: "ä¸‰ä¸ªæ•°æ®é›†æ²¡æœ‰å…±åŒçš„å‘˜å·¥å§“å" };
                }

                // æ£€æŸ¥æ•°æ®èŒƒå›´
                for (const [name, ratio] of Object.entries(overdueData)) {
                    if (ratio < 0 || ratio > 100) {
                        return { valid: false, message: `é€¾æœŸæ¯”ä¾‹æ•°æ®å¼‚å¸¸: ${name} = ${ratio}%` };
                    }
                }

                for (const [name, days] of Object.entries(meanOverdueData)) {
                    if (days < 0) {
                        return { valid: false, message: `é€¾æœŸå¤©æ•°æ•°æ®å¼‚å¸¸: ${name} = ${days}å¤©` };
                    }
                }

                for (const [name, workDays] of Object.entries(daysData)) {
                    if (workDays < 0) {
                        return { valid: false, message: `å·¥ä½œäººå¤©æ•°æ®å¼‚å¸¸: ${name} = ${workDays}äººå¤©` };
                    }
                }

                return { valid: true, message: `æ•°æ®éªŒè¯é€šè¿‡ï¼Œå…±${commonNames.size}åå‘˜å·¥` };
            }
        }

        // è¯„åˆ†è®¡ç®—å™¨
        class ScoringCalculator {
            constructor() {
                this.config = {
                    weights: {
                        overdue_ratio: 0.4,
                        overdue_days: 0.4,
                        work_days: 0.2
                    },
                    overdue_ratio_params: {
                        baseline: 20.0,
                        multiplier: 2.0,
                        max_score: 100,
                        min_score: 0
                    },
                    overdue_days_params: {
                        baseline: 2.0,
                        multiplier: 15,
                        max_score: 100,
                        min_score: 0
                    },
                    work_days_params: {
                        standard_days: 10,
                        bonus_tier1_max: 15,
                        bonus_tier1_rate: 2,
                        bonus_tier2_rate: 1,
                        bonus_tier3_max: 20,
                        bonus_tier3_rate: 0.5,
                        base_penalty_rate: 5,
                        progressive_multiplier: 1.2,
                        max_score: 130,
                        min_score: 20,
                        inflation_threshold: 15,
                        overload_threshold: 20
                    },
                    grade_thresholds: {
                        S: 85,
                        A: 70,
                        B: 55,
                        C: 40
                    }
                };
            }

            calculateOverdueRatioScore(ratio) {
                const params = this.config.overdue_ratio_params;
                const score = params.max_score - Math.max(0, ratio - params.baseline) * params.multiplier;
                return Math.max(params.min_score, Math.min(params.max_score, score));
            }

            calculateOverdueDaysScore(days) {
                const params = this.config.overdue_days_params;
                const baseline = params.baseline;

                if (days <= baseline) {
                    return params.max_score;
                }

                const buffer = 2.0;
                const score = params.max_score * (baseline + buffer) / (days + buffer);
                return Math.max(params.min_score, Math.round(score * 100) / 100);
            }

            calculateProgressivePenalty(days, standardDays, basePenaltyRate, multiplier) {
                if (days >= standardDays) {
                    return 0;
                }

                const gap = standardDays - days;
                const penaltyFactor = basePenaltyRate * Math.pow(multiplier, gap - 1);
                const totalPenalty = penaltyFactor * gap;
                return totalPenalty;
            }

            calculateWorkDaysScore(days) {
                const params = this.config.work_days_params;
                const standardDays = params.standard_days;

                if (days < standardDays) {
                    const penalty = this.calculateProgressivePenalty(
                        days,
                        standardDays,
                        params.base_penalty_rate,
                        params.progressive_multiplier
                    );
                    const score = 100 - penalty;
                    return Math.max(params.min_score, score);
                } else if (days === standardDays) {
                    return 100;
                } else if (standardDays < days && days <= params.bonus_tier1_max) {
                    const bonusDays = days - standardDays;
                    const score = 100 + bonusDays * params.bonus_tier1_rate;
                    return Math.min(params.max_score, score);
                } else if (params.bonus_tier1_max < days && days <= params.bonus_tier3_max) {
                    const tier1Bonus = (params.bonus_tier1_max - standardDays) * params.bonus_tier1_rate;
                    const tier2Bonus = (days - params.bonus_tier1_max) * params.bonus_tier2_rate;
                    const score = 100 + tier1Bonus + tier2Bonus;
                    return Math.min(params.max_score, score);
                } else {
                    const tier1Bonus = (params.bonus_tier1_max - standardDays) * params.bonus_tier1_rate;
                    const tier2Bonus = (params.bonus_tier3_max - params.bonus_tier1_max) * params.bonus_tier2_rate;
                    const tier3Bonus = (days - params.bonus_tier3_max) * params.bonus_tier3_rate;
                    const score = 100 + tier1Bonus + tier2Bonus + tier3Bonus;
                    return Math.min(params.max_score, score);
                }
            }

            calculateComprehensiveScore(overdueRatio, overdueDays, workDays) {
                const ratioScore = this.calculateOverdueRatioScore(overdueRatio);
                const daysScore = this.calculateOverdueDaysScore(overdueDays);
                const workDaysScore = this.calculateWorkDaysScore(workDays);

                const weights = this.config.weights;
                const comprehensiveScore = (
                    ratioScore * weights.overdue_ratio +
                    daysScore * weights.overdue_days +
                    workDaysScore * weights.work_days
                );

                return {
                    overdue_ratio_score: Math.round(ratioScore * 100) / 100,
                    overdue_days_score: Math.round(daysScore * 100) / 100,
                    work_days_score: Math.round(workDaysScore * 100) / 100,
                    comprehensive_score: Math.round(comprehensiveScore * 100) / 100
                };
            }

            getGrade(score) {
                const thresholds = this.config.grade_thresholds;
                if (score >= thresholds.S) return "S";
                if (score >= thresholds.A) return "A";
                if (score >= thresholds.B) return "B";
                if (score >= thresholds.C) return "C";
                return "D";
            }

            explainScore(overdueRatio, overdueDays, workDays) {
                const params = this.config.work_days_params;
                const explanation = [];

                if (overdueRatio <= 20) {
                    explanation.push(`âœ… é€¾æœŸæ¯”ä¾‹${overdueRatio.toFixed(1)}%è¡¨ç°è‰¯å¥½`);
                } else {
                    explanation.push(`âš ï¸ é€¾æœŸæ¯”ä¾‹${overdueRatio.toFixed(1)}%è¶…å‡ºåŸºå‡†(20%)`);
                }

                if (overdueDays <= 2) {
                    explanation.push(`âœ… é€¾æœŸå¤©æ•°${overdueDays.toFixed(1)}å¤©æ§åˆ¶è‰¯å¥½`);
                } else {
                    explanation.push(`âš ï¸ é€¾æœŸå¤©æ•°${overdueDays.toFixed(1)}å¤©è¶…å‡ºåŸºå‡†(2å¤©)`);
                }

                const standardDays = params.standard_days;
                if (workDays < standardDays) {
                    explanation.push(`ğŸ“‰ å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©ä¸è¶³(æ ‡å‡†${standardDays}äººå¤©)`);
                } else if (workDays === standardDays) {
                    explanation.push(`âœ… å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©æ ‡å‡†`);
                } else if (standardDays < workDays && workDays <= params.bonus_tier1_max) {
                    explanation.push(`ğŸ’ª å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©ä¼˜ç§€`);
                } else {
                    if (workDays > params.inflation_threshold) {
                        explanation.push(`ğŸ”¥ å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©è¶…é«˜âš ï¸éœ€æ ¸å®äººå¤©è®°å½•`);
                    } else {
                        explanation.push(`ğŸ”¥ å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©è¶…é«˜`);
                    }
                }

                return explanation;
            }

            needsReview(workDays) {
                return workDays > this.config.work_days_params.inflation_threshold;
            }
        }

        // å¤„ç†æ–‡ä»¶
        async function processFiles() {
            const loading = document.getElementById('loading');
            const btn = document.getElementById('process-btn');

            loading.style.display = 'block';
            btn.disabled = true;

            try {
                // è§£ææ•°æ®
                const overdueData = DataParser.parseOverdueData(fileData.overdue);
                const meanOverdueData = DataParser.parseMeanOverdueData(fileData.meanOverdue);
                const daysData = DataParser.parseDaysData(fileData.days);

                // éªŒè¯æ•°æ®
                const validation = DataParser.validateData(overdueData, meanOverdueData, daysData);
                if (!validation.valid) {
                    showError(validation.message);
                    return;
                }

                showSuccess(validation.message);

                // è®¡ç®—è¯„åˆ†
                const calculator = new ScoringCalculator();
                const results = [];

                const overdueNames = new Set(Object.keys(overdueData));
                const meanOverdueNames = new Set(Object.keys(meanOverdueData));
                const daysNames = new Set(Object.keys(daysData));

                const commonNames = Array.from(overdueNames).filter(name =>
                    meanOverdueNames.has(name) && daysNames.has(name)
                );

                console.log('Processing data for', commonNames.length, 'employees');
                console.log('Common names:', commonNames.sort());

                for (const name of commonNames) {
                    const scores = calculator.calculateComprehensiveScore(
                        overdueData[name],
                        meanOverdueData[name],
                        daysData[name]
                    );

                    const grade = calculator.getGrade(scores.comprehensive_score);
                    const explanation = calculator.explainScore(
                        overdueData[name],
                        meanOverdueData[name],
                        daysData[name]
                    );
                    const needsReview = calculator.needsReview(daysData[name]);

                    results.push({
                        name,
                        overdue_ratio: overdueData[name],
                        overdue_days: meanOverdueData[name],
                        work_days: daysData[name],
                        ...scores,
                        grade,
                        explanation,
                        needs_review: needsReview
                    });
                }

                // æ’åºç»“æœ
                results.sort((a, b) => b.comprehensive_score - a.comprehensive_score);

                // æ˜¾ç¤ºç»“æœ
                displayResults(results);
                showSuccess(`åˆ†æå®Œæˆï¼å…±å¤„ç†${results.length}åå‘˜å·¥æ•°æ®`);

            } catch (error) {
                showError(`å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsSection = document.getElementById('results-section');
            const tbody = document.getElementById('results-tbody');
            const statsGrid = document.getElementById('stats-grid');

            // æ¸…ç©ºç°æœ‰å†…å®¹
            tbody.innerHTML = '';
            statsGrid.innerHTML = '';

            // å¡«å……è¡¨æ ¼
            results.forEach((result, index) => {
                const row = document.createElement('tr');

                // åˆ›å»ºä¸‰åˆ—è¯´æ˜
                const explanationHtml = Array.isArray(result.explanation)
                    ? `
                        <div class="explanation-columns">
                            <div class="explanation-column">${result.explanation[0] || ''}</div>
                            <div class="explanation-column">${result.explanation[1] || ''}</div>
                            <div class="explanation-column">${result.explanation[2] || ''}</div>
                        </div>
                    `
                    : `<div class="explanation">${result.explanation}</div>`;

                row.innerHTML = `
                    <td class="col-rank">${index + 1}</td>
                    <td class="col-name">${result.name}</td>
                    <td class="col-overdue-ratio">${result.overdue_ratio.toFixed(1)}%</td>
                    <td class="col-overdue-days">${result.overdue_days.toFixed(1)}å¤©</td>
                    <td class="col-work-days">${result.work_days.toFixed(1)}äººå¤©</td>
                    <td class="col-score">${result.comprehensive_score}</td>
                    <td class="col-grade"><span class="grade grade-${result.grade}">${result.grade}</span></td>
                    <td class="col-explanation">${explanationHtml}</td>
                `;
                tbody.appendChild(row);
            });

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const stats = calculateStatistics(results);

            // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            const statCards = [
                { label: 'æ€»äººæ•°', value: stats.totalPeople },
                { label: 'å¹³å‡å¾—åˆ†', value: stats.averageScore.toFixed(1) + 'åˆ†' },
                { label: 'æœ€é«˜åˆ†', value: stats.maxScore + 'åˆ†' },
                { label: 'æœ€ä½åˆ†', value: stats.minScore + 'åˆ†' },
                { label: 'Sçº§äººæ•°', value: stats.gradeDistribution.S + 'äºº' },
                { label: 'éœ€æ ¸å®äººå¤©', value: stats.needsReviewCount + 'äºº' }
            ];

            statCards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'stat-card';
                cardDiv.innerHTML = `
                    <div class="stat-value">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                `;
                statsGrid.appendChild(cardDiv);
            });

            // ä¿å­˜ç»“æœç”¨äºå¯¼å‡º
            window.currentResults = results;

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultsSection.style.display = 'block';

            // åˆå§‹åŒ–è§†å›¾çŠ¶æ€ - ç¡®ä¿è¡¨æ ¼è§†å›¾æ˜¾ç¤ºï¼Œå…¶ä»–è§†å›¾éšè—
            switchView('table');

            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        function calculateStatistics(results) {
            const totalPeople = results.length;
            const scores = results.map(r => r.comprehensive_score);
            const averageScore = scores.reduce((a, b) => a + b, 0) / totalPeople;
            const maxScore = Math.max(...scores);
            const minScore = Math.min(...scores);

            const gradeDistribution = { S: 0, A: 0, B: 0, C: 0, D: 0 };
            results.forEach(r => {
                gradeDistribution[r.grade]++;
            });

            const needsReviewCount = results.filter(r => r.needs_review).length;

            return {
                totalPeople,
                averageScore,
                maxScore,
                minScore,
                gradeDistribution,
                needsReviewCount
            };
        }

        // å¯¼å‡ºCSV
        function exportToCSV() {
            if (!window.currentResults || window.currentResults.length === 0) {
                showError('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const results = window.currentResults;
            const headers = ['æ’å', 'å§“å', 'é€¾æœŸæ¯”ä¾‹', 'é€¾æœŸå¤©æ•°', 'å·¥ä½œäººå¤©', 'ç»¼åˆå¾—åˆ†', 'ç­‰çº§', 'è¯´æ˜'];

            const csvContent = [
                headers.join(','),
                ...results.map((result, index) => [
                    index + 1,
                    result.name,
                    result.overdue_ratio.toFixed(1) + '%',
                    result.overdue_days.toFixed(1) + 'å¤©',
                    result.work_days.toFixed(1) + 'äººå¤©',
                    result.comprehensive_score,
                    result.grade,
                    `"${result.explanation}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess('CSVæ–‡ä»¶å·²å¯¼å‡º');
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(viewType) {
            const tableView = document.querySelector('.results-table-container');
            const statsGrid = document.querySelector('.stats-grid');
            const analysisReport = document.querySelector('.analysis-report');

            // ç®¡ç†æŒ‰é’®çŠ¶æ€
            const tableBtn = document.getElementById('table-view-btn');
            const analysisBtn = document.getElementById('analysis-view-btn');

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
            tableBtn.classList.remove('active');
            analysisBtn.classList.remove('active');

            // éšè—æ‰€æœ‰è§†å›¾
            tableView.style.display = 'none';
            statsGrid.style.display = 'none';
            analysisReport.style.display = 'none';

            // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾å¹¶è®¾ç½®å¯¹åº”æŒ‰é’®ä¸ºactive
            switch(viewType) {
                case 'table':
                    tableView.style.display = 'block';
                    tableBtn.classList.add('active');
                    break;
                case 'stats':
                    statsGrid.style.display = 'grid';
                    break;
                case 'analysis':
                    analysisReport.style.display = 'block';
                    analysisBtn.classList.add('active');
                    generateAnalysisReport();
                    break;
            }
        }

        // ç”Ÿæˆåˆ†ææŠ¥å‘Š
        function generateAnalysisReport() {
            if (!window.currentResults || window.currentResults.length === 0) {
                showError('æ²¡æœ‰æ•°æ®å¯åˆ†æ');
                return;
            }

            const results = window.currentResults;

            // åŸºç¡€ç»Ÿè®¡
            const totalPeople = results.length;
            const avgScore = results.reduce((sum, r) => sum + r.comprehensive_score, 0) / totalPeople;
            const medianScore = getMedian(results.map(r => r.comprehensive_score));
            const minScore = Math.min(...results.map(r => r.comprehensive_score));
            const maxScore = Math.max(...results.map(r => r.comprehensive_score));

            // ç­‰çº§åˆ†å¸ƒ
            const gradeCount = {};
            results.forEach(r => {
                gradeCount[r.grade] = (gradeCount[r.grade] || 0) + 1;
            });

            // é€¾æœŸåˆ†æ
            const avgOverdueRatio = results.reduce((sum, r) => sum + r.overdue_ratio, 0) / totalPeople;
            const avgOverdueDays = results.reduce((sum, r) => sum + r.overdue_days, 0) / totalPeople;
            const seriousOverdue = results.filter(r => r.overdue_ratio > 50).length;
            const longOverdue = results.filter(r => r.overdue_days > 5).length;

            // å·¥ä½œé‡åˆ†æ
            const avgWorkDays = results.reduce((sum, r) => sum + r.work_days, 0) / totalPeople;
            const medianWorkDays = getMedian(results.map(r => r.work_days));
            const insufficientWork = results.filter(r => r.work_days < 8).length;
            const idealWork = results.filter(r => r.work_days >= 8 && r.work_days <= 10).length;
            const excellentWork = results.filter(r => r.work_days > 10 && r.work_days <= 15).length;
            const highWork = results.filter(r => r.work_days > 15).length;

            // æ›´æ–°åŸºç¡€ç»Ÿè®¡
            const totalPeopleEl = document.getElementById('total-people');
            const avgScoreEl = document.getElementById('avg-score');
            const medianScoreEl = document.getElementById('median-score');
            const scoreRangeEl = document.getElementById('score-range');

            totalPeopleEl.textContent = totalPeople;
            avgScoreEl.textContent = avgScore.toFixed(2) + 'åˆ†';
            medianScoreEl.textContent = medianScore.toFixed(2) + 'åˆ†';
            scoreRangeEl.textContent = `${minScore.toFixed(2)} - ${maxScore.toFixed(2)}åˆ†`;

            // æ·»åŠ çŠ¶æ€æŒ‡ç¤º
            avgScoreEl.className = 'stat-value ' + (avgScore >= 70 ? 'good' : avgScore >= 55 ? 'warning' : 'danger');

            // æ›´æ–°ç­‰çº§åˆ†å¸ƒ
            const sortedGrades = Object.entries(gradeCount)
                .sort(([a], [b]) => ['S', 'A', 'B', 'C', 'D'].indexOf(a) - ['S', 'A', 'B', 'C', 'D'].indexOf(b));

            // ç”Ÿæˆç­‰çº§æ±‡æ€»å¡ç‰‡
            const gradeSummaryHtml = sortedGrades.map(([grade, count]) => {
                const percentage = ((count / totalPeople) * 100).toFixed(1);
                return `<div class="grade-summary-item grade-${grade}">
                    <span class="grade-count-number">${count}</span>
                    <span class="grade-count-label">${grade}çº§ (${percentage}%)</span>
                </div>`;
            }).join('');

            // ç”Ÿæˆç­‰çº§æ¡å½¢å›¾
            const gradeBarsHtml = sortedGrades.map(([grade, count]) => {
                const percentage = ((count / totalPeople) * 100).toFixed(1);
                const barWidth = Math.max(percentage, 8); // æœ€å°å®½åº¦8%ä»¥ä¿è¯å¯è§æ€§
                return `<div class="grade-bar-item">
                    <div class="grade-bar-label">${grade}çº§</div>
                    <div class="grade-bar-container">
                        <div class="grade-bar-fill grade-${grade}" style="width: ${barWidth}%">
                            ${percentage}%
                        </div>
                    </div>
                    <div class="grade-bar-percentage">${count}äºº</div>
                </div>`;
            }).join('');

            document.getElementById('grade-summary').innerHTML = gradeSummaryHtml;
            document.getElementById('grade-bars').innerHTML = gradeBarsHtml;

            // æ›´æ–°é€¾æœŸåˆ†æ
            const avgOverdueRatioEl = document.getElementById('avg-overdue-ratio');
            const avgOverdueDaysEl = document.getElementById('avg-overdue-days');
            const seriousOverdueEl = document.getElementById('serious-overdue');
            const longOverdueEl = document.getElementById('long-overdue');

            avgOverdueRatioEl.textContent = avgOverdueRatio.toFixed(2) + '%';
            avgOverdueDaysEl.textContent = avgOverdueDays.toFixed(2) + 'å¤©';
            seriousOverdueEl.textContent = seriousOverdue + 'äºº';
            longOverdueEl.textContent = longOverdue + 'äºº';

            // æ·»åŠ çŠ¶æ€æŒ‡ç¤º
            avgOverdueRatioEl.className = 'stat-value ' + (avgOverdueRatio <= 20 ? 'good' : avgOverdueRatio <= 35 ? 'warning' : 'danger');
            avgOverdueDaysEl.className = 'stat-value ' + (avgOverdueDays <= 2 ? 'good' : avgOverdueDays <= 5 ? 'warning' : 'danger');
            seriousOverdueEl.className = 'stat-value ' + (seriousOverdue === 0 ? 'good' : seriousOverdue <= 5 ? 'warning' : 'danger');
            longOverdueEl.className = 'stat-value ' + (longOverdue === 0 ? 'good' : longOverdue <= 10 ? 'warning' : 'danger');

            // ç”Ÿæˆé€¾æœŸé—®é¢˜é«˜äº®
            generateOverdueProblems({
                avgOverdueRatio,
                avgOverdueDays,
                seriousOverdue,
                longOverdue,
                totalPeople
            });

            // æ›´æ–°å·¥ä½œé‡åˆ†æ
            const avgWorkDaysEl = document.getElementById('avg-work-days');
            const medianWorkDaysEl = document.getElementById('median-work-days');
            const insufficientWorkEl = document.getElementById('insufficient-work');
            const idealWorkEl = document.getElementById('ideal-work');
            const excellentWorkEl = document.getElementById('excellent-work');
            const highWorkEl = document.getElementById('high-work');

            avgWorkDaysEl.textContent = avgWorkDays.toFixed(2) + 'äººå¤©';
            medianWorkDaysEl.textContent = medianWorkDays.toFixed(2) + 'äººå¤©';
            insufficientWorkEl.textContent = insufficientWork + 'äºº';
            idealWorkEl.textContent = idealWork + 'äºº';
            excellentWorkEl.textContent = excellentWork + 'äºº';
            highWorkEl.textContent = highWork + 'äºº';

            // æ·»åŠ çŠ¶æ€æŒ‡ç¤º
            avgWorkDaysEl.className = 'stat-value info';
            medianWorkDaysEl.className = 'stat-value info';
            insufficientWorkEl.className = 'stat-value ' + (insufficientWork === 0 ? 'good' : insufficientWork <= 5 ? 'warning' : 'danger');
            idealWorkEl.className = 'stat-value ' + (idealWork >= totalPeople * 0.3 ? 'good' : idealWork >= totalPeople * 0.2 ? 'warning' : 'info');
            excellentWorkEl.className = 'stat-value ' + (excellentWork >= totalPeople * 0.2 ? 'good' : 'info');
            highWorkEl.className = 'stat-value ' + (highWork === 0 ? 'good' : highWork <= 3 ? 'warning' : 'danger');

            // æ›´æ–°Highlightå€™é€‰ (Sçº§)
            const highlightEmployees = results.filter(r => r.grade === 'S' && r.comprehensive_score >= 85);
            const highlightHtml = highlightEmployees.map(emp => `
                <div class="employee-card">
                    <div class="employee-header">
                        <span class="employee-name">${emp.name}</span>
                        <span class="employee-score">${emp.comprehensive_score.toFixed(2)}åˆ†</span>
                    </div>
                    <div class="employee-details">${emp.explanation}</div>
                </div>
            `).join('');
            document.getElementById('highlight-employees').innerHTML = highlightHtml || '<p>æš‚æ— Highlightå€™é€‰</p>';

            // æ›´æ–°Lowlightéœ€å…³æ³¨ (Dçº§)
            const lowlightEmployees = results.filter(r => r.grade === 'D' && r.comprehensive_score < 40);
            const lowlightHtml = lowlightEmployees.map(emp => `
                <div class="employee-card">
                    <div class="employee-header">
                        <span class="employee-name">${emp.name}</span>
                        <span class="employee-score">${emp.comprehensive_score.toFixed(2)}åˆ†</span>
                    </div>
                    <div class="employee-details">${emp.explanation}</div>
                </div>
            `).join('');
            document.getElementById('lowlight-employees').innerHTML = lowlightHtml || '<p>æš‚æ— Lowlightéœ€å…³æ³¨</p>';

            // æ›´æ–°éœ€æ ¸å®äººå¤©è®°å½• (>15äººå¤©)
            const reviewEmployees = results.filter(r => r.work_days > 15);
            const reviewHtml = reviewEmployees.map(emp => `
                <div class="employee-card">
                    <div class="employee-header">
                        <span class="employee-name">${emp.name}</span>
                        <span class="employee-score">${emp.comprehensive_score.toFixed(2)}åˆ†</span>
                    </div>
                    <div class="employee-details">
                        ${emp.work_days.toFixed(1)}äººå¤© - å»ºè®®æ ¸å®ï¼šæ˜¯å¦å­˜åœ¨äººå¤©è®°å½•è†¨èƒ€æˆ–é‡å¤ç»Ÿè®¡
                    </div>
                </div>
            `).join('');
            document.getElementById('review-employees').innerHTML = reviewHtml || '<p>æš‚æ— éœ€æ ¸å®çš„äººå¤©è®°å½•</p>';

            // æ›´æ–°å›¢é˜Ÿæ”¹è¿›å»ºè®®
            const suggestions = generateActionableSuggestions(results, {
                avgOverdueRatio,
                avgOverdueDays,
                insufficientWork,
                seriousOverdue,
                highlightCount: highlightEmployees.length
            });
            document.getElementById('team-suggestions').innerHTML = suggestions;
        }

        // ç”Ÿæˆé€¾æœŸé—®é¢˜é«˜äº®
        function generateOverdueProblems(overdueStats) {
            const problems = [];

            if (overdueStats.avgOverdueRatio > 40) {
                problems.push({
                    title: 'ä¸¥é‡é€¾æœŸè­¦å‘Š',
                    value: `${overdueStats.avgOverdueRatio.toFixed(1)}%`,
                    description: 'é€¾æœŸæ¯”ä¾‹ä¸¥é‡è¶…æ ‡ï¼Œéœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨'
                });
            }

            if (overdueStats.avgOverdueDays > 8) {
                problems.push({
                    title: 'é¡¹ç›®å»¶æœŸä¸¥é‡',
                    value: `${overdueStats.avgOverdueDays.toFixed(1)}å¤©`,
                    description: 'å¹³å‡å»¶æœŸæ—¶é—´è¿‡é•¿ï¼Œä¸¥é‡å½±å“äº¤ä»˜è®¡åˆ’'
                });
            }

            if (overdueStats.seriousOverdue > overdueStats.totalPeople * 0.3) {
                problems.push({
                    title: 'å¤§é¢ç§¯ä¸¥é‡é€¾æœŸ',
                    value: `${overdueStats.seriousOverdue}äºº`,
                    description: 'è¶…è¿‡30%çš„å›¢é˜Ÿæˆå‘˜å­˜åœ¨ä¸¥é‡é€¾æœŸé—®é¢˜'
                });
            }

            const problemsHtml = problems.length > 0 ? problems.map(problem => `
                <div class="problem-highlight">
                    <div class="problem-title">${problem.title}</div>
                    <div class="problem-value">${problem.value}</div>
                    <div style="font-size: 13px; color: #856404; margin-top: 4px;">${problem.description}</div>
                </div>
            `).join('') : '<div style="text-align: center; color: #27ae60; padding: 12px;">âœ… é€¾æœŸçŠ¶å†µåœ¨å¯æ§èŒƒå›´å†…</div>';

            document.getElementById('overdue-problems').innerHTML = problemsHtml;
        }

        // ç”Ÿæˆå›¢é˜Ÿæ”¹è¿›å»ºè®®
        function generateActionableSuggestions(results, stats) {
            const actions = [];
            const totalPeople = results.length;

            // é€¾æœŸé—®é¢˜è¡ŒåŠ¨å»ºè®®
            if (stats.avgOverdueRatio > 40) {
                actions.push({
                    type: 'critical',
                    icon: 'ğŸš¨',
                    title: 'ç«‹å³è¡ŒåŠ¨ï¼šè§£å†³ä¸¥é‡é€¾æœŸé—®é¢˜',
                    description: `å›¢é˜Ÿå¹³å‡é€¾æœŸæ¯”ä¾‹è¾¾åˆ°${stats.avgOverdueRatio.toFixed(1)}%ï¼Œä¸¥é‡å½±å“é¡¹ç›®äº¤ä»˜ã€‚éœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨ã€‚`,
                    metrics: [`é€¾æœŸæ¯”ä¾‹: ${stats.avgOverdueRatio.toFixed(1)}%`, `å½±å“äººæ•°: ${Math.round(totalPeople * 0.6)}äºº`],
                    actions: ['å¬å¼€ç´§æ€¥é¡¹ç›®è¯„å®¡ä¼š', 'é‡æ–°è¯„ä¼°ä»»åŠ¡æ—¶é—´ä¼°ç®—', 'å»ºç«‹æ¯æ—¥è¿›åº¦è·Ÿè¸ªæœºåˆ¶']
                });
            } else if (stats.avgOverdueRatio > 25) {
                actions.push({
                    type: 'important',
                    icon: 'âš ï¸',
                    title: 'é‡ç‚¹å…³æ³¨ï¼šæ”¹å–„é€¾æœŸçŠ¶å†µ',
                    description: `é€¾æœŸæ¯”ä¾‹${stats.avgOverdueRatio.toFixed(1)}%è¶…å‡ºå¯æ¥å—èŒƒå›´ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨ã€‚`,
                    metrics: [`å½“å‰: ${stats.avgOverdueRatio.toFixed(1)}%`, `ç›®æ ‡: <20%`],
                    actions: ['ä¼˜åŒ–ä»»åŠ¡åˆ†è§£', 'å¢åŠ å‘¨åº¦è¿›åº¦æ£€æŸ¥', 'è¯†åˆ«é˜»å¡å› ç´ ']
                });
            }

            // é€¾æœŸå¤©æ•°è¡ŒåŠ¨å»ºè®®
            if (stats.avgOverdueDays > 8) {
                actions.push({
                    type: 'critical',
                    icon: 'ğŸ“…',
                    title: 'ç´§æ€¥ï¼šç¼©çŸ­é¡¹ç›®å‘¨æœŸ',
                    description: `å¹³å‡é€¾æœŸ${stats.avgOverdueDays.toFixed(1)}å¤©ï¼Œä¸¥é‡å½±å“é¡¹ç›®è¿›åº¦å’Œå®¢æˆ·æ»¡æ„åº¦ã€‚`,
                    metrics: [`å¹³å‡é€¾æœŸ: ${stats.avgOverdueDays.toFixed(1)}å¤©`, `åŸºå‡†: 2å¤©`],
                    actions: ['å®æ–½æ•æ·å¼€å‘æ–¹æ³•', 'å»ºç«‹é£é™©é¢„è­¦æœºåˆ¶', 'ä¼˜åŒ–èµ„æºé…ç½®']
                });
            }

            // å·¥ä½œé‡åˆ†å¸ƒè¡ŒåŠ¨å»ºè®®
            const insufficientPercentage = (stats.insufficientWork / totalPeople * 100).toFixed(1);
            if (stats.insufficientWork > totalPeople * 0.4) {
                actions.push({
                    type: 'important',
                    icon: 'âš–ï¸',
                    title: 'é‡æ–°å¹³è¡¡ï¼šå·¥ä½œä»»åŠ¡åˆ†é…',
                    description: `${insufficientPercentage}%çš„å›¢é˜Ÿæˆå‘˜å·¥ä½œé‡ä¸è¶³ï¼Œéœ€è¦é‡æ–°åˆ†é…ä»»åŠ¡ã€‚`,
                    metrics: [`ä¸è¶³äººæ•°: ${stats.insufficientWork}äºº`, `å æ¯”: ${insufficientPercentage}%`],
                    actions: ['è¯„ä¼°æŠ€èƒ½åŒ¹é…åº¦', 'é‡æ–°åˆ†é…é¡¹ç›®ä»»åŠ¡', 'è€ƒè™‘è·¨éƒ¨é—¨åä½œ']
                });
            }

            // é«˜äººå¤©æ ¸å®è¡ŒåŠ¨å»ºè®®
            const highWorkCount = results.filter(r => r.work_days > 15).length;
            if (highWorkCount > 0) {
                actions.push({
                    type: 'recommendation',
                    icon: 'ğŸ”',
                    title: 'æ•°æ®æ ¸å®ï¼šéªŒè¯é«˜äººå¤©è®°å½•',
                    description: `å‘ç°${highWorkCount}äººå·¥ä½œäººå¤©è¶…è¿‡15å¤©ï¼Œéœ€è¦æ ¸å®æ•°æ®å‡†ç¡®æ€§ã€‚`,
                    metrics: [`æ¶‰åŠäººæ•°: ${highWorkCount}äºº`, `éœ€æ ¸å®è®°å½•`],
                    actions: ['æ ¸æŸ¥æ—¶é—´è®°å½•ç³»ç»Ÿ', 'ç¡®è®¤å·¥ä½œå†…å®¹çœŸå®æ€§', 'å»ºç«‹æ•°æ®å®¡æ ¸æœºåˆ¶']
                });
            }

            // ä¼˜ç§€è¡¨ç°è®¤å¯
            if (stats.highlightCount > 0) {
                actions.push({
                    type: 'recommendation',
                    icon: 'ğŸ†',
                    title: 'è¡¨å½°ä¼˜ç§€ï¼šæ ‘ç«‹å­¦ä¹ æ¦œæ ·',
                    description: `${stats.highlightCount}ååŒäº‹è¡¨ç°ä¼˜ç§€ï¼Œåº”è¯¥äºˆä»¥è¡¨å½°å¹¶æ¨å¹¿ç»éªŒã€‚`,
                    metrics: [`ä¼˜ç§€äººæ•°: ${stats.highlightCount}äºº`, `å æ¯”: ${(stats.highlightCount/totalPeople*100).toFixed(1)}%`],
                    actions: ['ç»„ç»‡ç»éªŒåˆ†äº«ä¼š', 'å»ºç«‹æœ€ä½³å®è·µåº“', 'è€ƒè™‘æ™‹å‡å‘å±•æœºä¼š']
                });
            }

            // å¦‚æœæ²¡æœ‰ä¸¥é‡é—®é¢˜ï¼Œç»™å‡ºæ­£é¢å»ºè®®
            if (actions.length === 0) {
                actions.push({
                    type: 'recommendation',
                    icon: 'âœ…',
                    title: 'ä¿æŒè‰¯å¥½çŠ¶æ€',
                    description: 'å›¢é˜Ÿæ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒç°æœ‰å·¥ä½œçŠ¶æ€å¹¶æŒç»­ä¼˜åŒ–ã€‚',
                    metrics: ['å›¢é˜ŸçŠ¶æ€: è‰¯å¥½', 'å„é¡¹æŒ‡æ ‡: æ­£å¸¸'],
                    actions: ['å®šæœŸå›é¡¾æ€»ç»“', 'æŒç»­æ”¹è¿›æµç¨‹', 'å…³æ³¨å›¢é˜Ÿæˆå‘˜å‘å±•']
                });
            }

            return actions.map(action => `
                <div class="action-item ${action.type}">
                    <div class="action-title">${action.icon} ${action.title}</div>
                    <div class="action-description">${action.description}</div>
                    <div style="margin-top: 8px;">
                        ${action.metrics.map(metric => `<span class="action-metric">${metric}</span>`).join('')}
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #6c757d;">
                        <strong>å»ºè®®è¡ŒåŠ¨:</strong> ${action.actions.join(' â†’ ')}
                    </div>
                </div>
            `).join('');
        }

        // è®¡ç®—ä¸­ä½æ•°
        function getMedian(numbers) {
            const sorted = numbers.slice().sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ æ”¯æŒ
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                console.log('æ–‡ä»¶ä¸Šä¼ APIæ”¯æŒ');
            } else {
                showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½');
            }
        });
    </script>
</body>
</html>