<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”å‘å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .upload-box:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .upload-box.has-file {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            font-size: 1.1em;
            color: #555;
            margin-bottom: 10px;
        }

        .upload-box.has-file .upload-label {
            color: #27ae60;
        }

        .file-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .process-btn {
            display: block;
            width: 200px;
            margin: 0 auto;
            padding: 15px 30px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .process-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .export-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .export-btn:hover {
            background: #219a52;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        /* Column-specific width classes */
        .col-rank { width: 60px; min-width: 60px; }
        .col-name { width: 120px; min-width: 120px; }
        .col-overdue-ratio { width: 110px; min-width: 110px; }
        .col-overdue-days { width: 110px; min-width: 110px; }
        .col-work-days { width: 110px; min-width: 110px; }
        .col-score { width: 90px; min-width: 90px; }
        .col-grade { width: 80px; min-width: 80px; }
        .col-explanation { min-width: 500px; width: auto; }

        .results-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .grade {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            min-width: 30px;
            display: inline-block;
        }

        .grade-S { background: #2ecc71; color: white; }
        .grade-A { background: #3498db; color: white; }
        .grade-B { background: #f39c12; color: white; }
        .grade-C { background: #e67e22; color: white; }
        .grade-D { background: #e74c3c; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .explanation {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .explanation-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            text-align: left;
            line-height: 1.3;
        }

        .explanation-column {
            padding: 6px 8px;
            border-radius: 5px;
            background: #f8f9fa;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .explanation-column:hover {
            background: #e9ecef;
            white-space: normal;
            overflow: visible;
            position: relative;
            z-index: 1;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .upload-section,
            .results-section {
                padding: 20px;
            }

            .results-table {
                font-size: 0.8em;
            }

            .results-table th,
            .results-table td {
                padding: 6px 4px;
            }

            .col-name,
            .col-overdue-ratio,
            .col-overdue-days,
            .col-work-days,
            .col-score,
            .col-grade {
                min-width: 80px;
            }

            .col-explanation {
                min-width: 300px;
            }

            .explanation-columns {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .explanation-column {
                padding: 3px 4px;
                font-size: 0.8em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.3;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 8px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .upload-section,
            .results-section {
                padding: 15px;
            }

            .results-table {
                font-size: 0.7em;
            }

            .results-table th,
            .results-table td {
                padding: 4px 2px;
            }

            .col-name,
            .col-overdue-ratio,
            .col-overdue-days,
            .col-work-days,
            .col-score,
            .col-grade {
                min-width: 60px;
            }

            .col-explanation {
                min-width: 250px;
            }

            .explanation-columns {
                grid-template-columns: 1fr;
                gap: 3px;
            }

            .explanation-column {
                padding: 2px 3px;
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç ”å‘å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†ç³»ç»Ÿ</h1>
            <p>åŸºäºPythonè¯„åˆ†ç®—æ³•çš„ç½‘é¡µç‰ˆ - æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œå®æ—¶åˆ†æ</p>
        </div>

        <div class="upload-section">
            <div class="upload-grid">
                <div class="upload-box" id="overdue-box">
                    <label for="overdue-file" class="upload-label">
                        ğŸ“Š é€¾æœŸæ¯”ä¾‹æ•°æ®
                    </label>
                    <input type="file" id="overdue-file" accept=".data,.txt" onchange="handleFileSelect('overdue', this)">
                    <div class="file-info" id="overdue-info">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-box" id="mean-overdue-box">
                    <label for="mean-overdue-file" class="upload-label">
                        â° é€¾æœŸå¤©æ•°æ•°æ®
                    </label>
                    <input type="file" id="mean-overdue-file" accept=".data,.txt" onchange="handleFileSelect('mean-overdue', this)">
                    <div class="file-info" id="mean-overdue-info">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-box" id="days-box">
                    <label for="days-file" class="upload-label">
                        ğŸ’¼ å·¥ä½œäººå¤©æ•°æ®
                    </label>
                    <input type="file" id="days-file" accept=".data,.txt" onchange="handleFileSelect('days', this)">
                    <div class="file-info" id="days-info">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                </div>
            </div>

            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨å¤„ç†æ•°æ®...</div>
            </div>

            <button class="process-btn" id="process-btn" onclick="processFiles()" disabled>
                å¼€å§‹åˆ†æ
            </button>
        </div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <h2>è¯„åˆ†ç»“æœ</h2>
                <button class="export-btn" onclick="exportToCSV()">å¯¼å‡ºCSV</button>
            </div>

            <div class="results-table-container">
                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th class="col-rank">æ’å</th>
                            <th class="col-name">å§“å</th>
                            <th class="col-overdue-ratio">é€¾æœŸæ¯”ä¾‹</th>
                            <th class="col-overdue-days">é€¾æœŸå¤©æ•°</th>
                            <th class="col-work-days">å·¥ä½œäººå¤©</th>
                            <th class="col-score">ç»¼åˆå¾—åˆ†</th>
                            <th class="col-grade">ç­‰çº§</th>
                            <th class="col-explanation">è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
            </div>

            <div class="stats-grid" id="stats-grid">
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileData = {
            overdue: null,
            meanOverdue: null,
            days: null
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(type, input) {
            const file = input.files[0];
            if (!file) return;

            const box = document.getElementById(type + '-box');
            const info = document.getElementById(type + '-info');

            box.classList.add('has-file');
            info.textContent = `å·²é€‰æ‹©: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                fileData[type === 'mean-overdue' ? 'meanOverdue' : type] = e.target.result;
                checkAllFilesLoaded();
            };
            reader.readAsText(file, 'UTF-8');
        }

        // æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å·²åŠ è½½
        function checkAllFilesLoaded() {
            const btn = document.getElementById('process-btn');
            if (fileData.overdue && fileData.meanOverdue && fileData.days) {
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹åˆ†æ';
            } else {
                btn.disabled = true;
                btn.textContent = 'è¯·ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // æ•°æ®è§£æå™¨
        class DataParser {
            static parseOverdueData(content) {
                const data = {};
                const lines = content.split('\n').filter(line => line.trim());

                console.log('Overdue data lines:', lines.length);

                for (let i = 0; i < lines.length; i += 3) {
                    if (i + 2 < lines.length) {
                        const name = lines[i].trim();
                        const ratioStr = lines[i + 1].trim();
                        const ratio = parseFloat(ratioStr.replace('%', ''));
                        if (!isNaN(ratio) && name) {
                            data[name] = ratio;
                            console.log(`Overdue: ${name} = ${ratio}%`);
                        }
                    }
                }
                console.log('Overdue data parsed:', Object.keys(data).length, 'entries');
                return data;
            }

            static parseMeanOverdueData(content) {
                const data = {};
                const lines = content.split('\n').filter(line => line.trim());

                console.log('Mean overdue data lines:', lines.length);

                for (let i = 0; i < lines.length; i += 3) {
                    if (i + 2 < lines.length) {
                        const name = lines[i].trim();
                        const days = parseFloat(lines[i + 1].trim());
                        if (!isNaN(days) && name) {
                            data[name] = days;
                            console.log(`Mean overdue: ${name} = ${days} days`);
                        }
                    }
                }
                console.log('Mean overdue data parsed:', Object.keys(data).length, 'entries');
                return data;
            }

            static parseDaysData(content) {
                const data = {};
                const lines = content.split('\n').filter(line => line.trim());

                console.log('Days data lines:', lines.length);

                for (let i = 0; i < lines.length; i += 5) {
                    if (i + 4 < lines.length) {
                        const name = lines[i].trim();
                        const workDays = parseFloat(lines[i + 1].trim());
                        if (!isNaN(workDays) && name) {
                            data[name] = workDays;
                            console.log(`Days: ${name} = ${workDays} work days`);
                        }
                    }
                }
                console.log('Days data parsed:', Object.keys(data).length, 'entries');
                return data;
            }

            static validateData(overdueData, meanOverdueData, daysData) {
                if (!overdueData || !meanOverdueData || !daysData) {
                    return { valid: false, message: "å­˜åœ¨ç©ºæ•°æ®é›†" };
                }

                console.log('Data validation:');
                console.log('- Overdue entries:', Object.keys(overdueData).length);
                console.log('- Mean overdue entries:', Object.keys(meanOverdueData).length);
                console.log('- Days entries:', Object.keys(daysData).length);

                const overdueNames = new Set(Object.keys(overdueData));
                const meanOverdueNames = new Set(Object.keys(meanOverdueData));
                const daysNames = new Set(Object.keys(daysData));

                const commonNames = new Set([...overdueNames].filter(name =>
                    meanOverdueNames.has(name) && daysNames.has(name)
                ));

                console.log('- Common names:', commonNames.size);
                console.log('- Names in all three datasets:', Array.from(commonNames).sort());

                if (commonNames.size === 0) {
                    return { valid: false, message: "ä¸‰ä¸ªæ•°æ®é›†æ²¡æœ‰å…±åŒçš„å‘˜å·¥å§“å" };
                }

                // æ£€æŸ¥æ•°æ®èŒƒå›´
                for (const [name, ratio] of Object.entries(overdueData)) {
                    if (ratio < 0 || ratio > 100) {
                        return { valid: false, message: `é€¾æœŸæ¯”ä¾‹æ•°æ®å¼‚å¸¸: ${name} = ${ratio}%` };
                    }
                }

                for (const [name, days] of Object.entries(meanOverdueData)) {
                    if (days < 0) {
                        return { valid: false, message: `é€¾æœŸå¤©æ•°æ•°æ®å¼‚å¸¸: ${name} = ${days}å¤©` };
                    }
                }

                for (const [name, workDays] of Object.entries(daysData)) {
                    if (workDays < 0) {
                        return { valid: false, message: `å·¥ä½œäººå¤©æ•°æ®å¼‚å¸¸: ${name} = ${workDays}äººå¤©` };
                    }
                }

                return { valid: true, message: `æ•°æ®éªŒè¯é€šè¿‡ï¼Œå…±${commonNames.size}åå‘˜å·¥` };
            }
        }

        // è¯„åˆ†è®¡ç®—å™¨
        class ScoringCalculator {
            constructor() {
                this.config = {
                    weights: {
                        overdue_ratio: 0.4,
                        overdue_days: 0.4,
                        work_days: 0.2
                    },
                    overdue_ratio_params: {
                        baseline: 20.0,
                        multiplier: 2.0,
                        max_score: 100,
                        min_score: 0
                    },
                    overdue_days_params: {
                        baseline: 2.0,
                        multiplier: 15,
                        max_score: 100,
                        min_score: 0
                    },
                    work_days_params: {
                        standard_days: 10,
                        bonus_tier1_max: 15,
                        bonus_tier1_rate: 2,
                        bonus_tier2_rate: 1,
                        bonus_tier3_max: 20,
                        bonus_tier3_rate: 0.5,
                        base_penalty_rate: 5,
                        progressive_multiplier: 1.2,
                        max_score: 130,
                        min_score: 20,
                        inflation_threshold: 15,
                        overload_threshold: 20
                    },
                    grade_thresholds: {
                        S: 85,
                        A: 70,
                        B: 55,
                        C: 40
                    }
                };
            }

            calculateOverdueRatioScore(ratio) {
                const params = this.config.overdue_ratio_params;
                const score = params.max_score - Math.max(0, ratio - params.baseline) * params.multiplier;
                return Math.max(params.min_score, Math.min(params.max_score, score));
            }

            calculateOverdueDaysScore(days) {
                const params = this.config.overdue_days_params;
                const baseline = params.baseline;

                if (days <= baseline) {
                    return params.max_score;
                }

                const buffer = 2.0;
                const score = params.max_score * (baseline + buffer) / (days + buffer);
                return Math.max(params.min_score, Math.round(score * 100) / 100);
            }

            calculateProgressivePenalty(days, standardDays, basePenaltyRate, multiplier) {
                if (days >= standardDays) {
                    return 0;
                }

                const gap = standardDays - days;
                const penaltyFactor = basePenaltyRate * Math.pow(multiplier, gap - 1);
                const totalPenalty = penaltyFactor * gap;
                return totalPenalty;
            }

            calculateWorkDaysScore(days) {
                const params = this.config.work_days_params;
                const standardDays = params.standard_days;

                if (days < standardDays) {
                    const penalty = this.calculateProgressivePenalty(
                        days,
                        standardDays,
                        params.base_penalty_rate,
                        params.progressive_multiplier
                    );
                    const score = 100 - penalty;
                    return Math.max(params.min_score, score);
                } else if (days === standardDays) {
                    return 100;
                } else if (standardDays < days && days <= params.bonus_tier1_max) {
                    const bonusDays = days - standardDays;
                    const score = 100 + bonusDays * params.bonus_tier1_rate;
                    return Math.min(params.max_score, score);
                } else if (params.bonus_tier1_max < days && days <= params.bonus_tier3_max) {
                    const tier1Bonus = (params.bonus_tier1_max - standardDays) * params.bonus_tier1_rate;
                    const tier2Bonus = (days - params.bonus_tier1_max) * params.bonus_tier2_rate;
                    const score = 100 + tier1Bonus + tier2Bonus;
                    return Math.min(params.max_score, score);
                } else {
                    const tier1Bonus = (params.bonus_tier1_max - standardDays) * params.bonus_tier1_rate;
                    const tier2Bonus = (params.bonus_tier3_max - params.bonus_tier1_max) * params.bonus_tier2_rate;
                    const tier3Bonus = (days - params.bonus_tier3_max) * params.bonus_tier3_rate;
                    const score = 100 + tier1Bonus + tier2Bonus + tier3Bonus;
                    return Math.min(params.max_score, score);
                }
            }

            calculateComprehensiveScore(overdueRatio, overdueDays, workDays) {
                const ratioScore = this.calculateOverdueRatioScore(overdueRatio);
                const daysScore = this.calculateOverdueDaysScore(overdueDays);
                const workDaysScore = this.calculateWorkDaysScore(workDays);

                const weights = this.config.weights;
                const comprehensiveScore = (
                    ratioScore * weights.overdue_ratio +
                    daysScore * weights.overdue_days +
                    workDaysScore * weights.work_days
                );

                return {
                    overdue_ratio_score: Math.round(ratioScore * 100) / 100,
                    overdue_days_score: Math.round(daysScore * 100) / 100,
                    work_days_score: Math.round(workDaysScore * 100) / 100,
                    comprehensive_score: Math.round(comprehensiveScore * 100) / 100
                };
            }

            getGrade(score) {
                const thresholds = this.config.grade_thresholds;
                if (score >= thresholds.S) return "S";
                if (score >= thresholds.A) return "A";
                if (score >= thresholds.B) return "B";
                if (score >= thresholds.C) return "C";
                return "D";
            }

            explainScore(overdueRatio, overdueDays, workDays) {
                const params = this.config.work_days_params;
                const explanation = [];

                if (overdueRatio <= 20) {
                    explanation.push(`âœ… é€¾æœŸæ¯”ä¾‹${overdueRatio.toFixed(1)}%è¡¨ç°è‰¯å¥½`);
                } else {
                    explanation.push(`âš ï¸ é€¾æœŸæ¯”ä¾‹${overdueRatio.toFixed(1)}%è¶…å‡ºåŸºå‡†(20%)`);
                }

                if (overdueDays <= 2) {
                    explanation.push(`âœ… é€¾æœŸå¤©æ•°${overdueDays.toFixed(1)}å¤©æ§åˆ¶è‰¯å¥½`);
                } else {
                    explanation.push(`âš ï¸ é€¾æœŸå¤©æ•°${overdueDays.toFixed(1)}å¤©è¶…å‡ºåŸºå‡†(2å¤©)`);
                }

                const standardDays = params.standard_days;
                if (workDays < standardDays) {
                    explanation.push(`ğŸ“‰ å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©ä¸è¶³(æ ‡å‡†${standardDays}äººå¤©)`);
                } else if (workDays === standardDays) {
                    explanation.push(`âœ… å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©æ ‡å‡†`);
                } else if (standardDays < workDays && workDays <= params.bonus_tier1_max) {
                    explanation.push(`ğŸ’ª å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©ä¼˜ç§€`);
                } else {
                    if (workDays > params.inflation_threshold) {
                        explanation.push(`ğŸ”¥ å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©è¶…é«˜âš ï¸éœ€æ ¸å®äººå¤©è®°å½•`);
                    } else {
                        explanation.push(`ğŸ”¥ å·¥ä½œé‡${workDays.toFixed(1)}äººå¤©è¶…é«˜`);
                    }
                }

                return explanation;
            }

            needsReview(workDays) {
                return workDays > this.config.work_days_params.inflation_threshold;
            }
        }

        // å¤„ç†æ–‡ä»¶
        async function processFiles() {
            const loading = document.getElementById('loading');
            const btn = document.getElementById('process-btn');

            loading.style.display = 'block';
            btn.disabled = true;

            try {
                // è§£ææ•°æ®
                const overdueData = DataParser.parseOverdueData(fileData.overdue);
                const meanOverdueData = DataParser.parseMeanOverdueData(fileData.meanOverdue);
                const daysData = DataParser.parseDaysData(fileData.days);

                // éªŒè¯æ•°æ®
                const validation = DataParser.validateData(overdueData, meanOverdueData, daysData);
                if (!validation.valid) {
                    showError(validation.message);
                    return;
                }

                showSuccess(validation.message);

                // è®¡ç®—è¯„åˆ†
                const calculator = new ScoringCalculator();
                const results = [];

                const overdueNames = new Set(Object.keys(overdueData));
                const meanOverdueNames = new Set(Object.keys(meanOverdueData));
                const daysNames = new Set(Object.keys(daysData));

                const commonNames = Array.from(overdueNames).filter(name =>
                    meanOverdueNames.has(name) && daysNames.has(name)
                );

                console.log('Processing data for', commonNames.length, 'employees');
                console.log('Common names:', commonNames.sort());

                for (const name of commonNames) {
                    const scores = calculator.calculateComprehensiveScore(
                        overdueData[name],
                        meanOverdueData[name],
                        daysData[name]
                    );

                    const grade = calculator.getGrade(scores.comprehensive_score);
                    const explanation = calculator.explainScore(
                        overdueData[name],
                        meanOverdueData[name],
                        daysData[name]
                    );
                    const needsReview = calculator.needsReview(daysData[name]);

                    results.push({
                        name,
                        overdue_ratio: overdueData[name],
                        overdue_days: meanOverdueData[name],
                        work_days: daysData[name],
                        ...scores,
                        grade,
                        explanation,
                        needs_review: needsReview
                    });
                }

                // æ’åºç»“æœ
                results.sort((a, b) => b.comprehensive_score - a.comprehensive_score);

                // æ˜¾ç¤ºç»“æœ
                displayResults(results);
                showSuccess(`åˆ†æå®Œæˆï¼å…±å¤„ç†${results.length}åå‘˜å·¥æ•°æ®`);

            } catch (error) {
                showError(`å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsSection = document.getElementById('results-section');
            const tbody = document.getElementById('results-tbody');
            const statsGrid = document.getElementById('stats-grid');

            // æ¸…ç©ºç°æœ‰å†…å®¹
            tbody.innerHTML = '';
            statsGrid.innerHTML = '';

            // å¡«å……è¡¨æ ¼
            results.forEach((result, index) => {
                const row = document.createElement('tr');

                // åˆ›å»ºä¸‰åˆ—è¯´æ˜
                const explanationHtml = Array.isArray(result.explanation)
                    ? `
                        <div class="explanation-columns">
                            <div class="explanation-column">${result.explanation[0] || ''}</div>
                            <div class="explanation-column">${result.explanation[1] || ''}</div>
                            <div class="explanation-column">${result.explanation[2] || ''}</div>
                        </div>
                    `
                    : `<div class="explanation">${result.explanation}</div>`;

                row.innerHTML = `
                    <td class="col-rank">${index + 1}</td>
                    <td class="col-name">${result.name}</td>
                    <td class="col-overdue-ratio">${result.overdue_ratio.toFixed(1)}%</td>
                    <td class="col-overdue-days">${result.overdue_days.toFixed(1)}å¤©</td>
                    <td class="col-work-days">${result.work_days.toFixed(1)}äººå¤©</td>
                    <td class="col-score">${result.comprehensive_score}</td>
                    <td class="col-grade"><span class="grade grade-${result.grade}">${result.grade}</span></td>
                    <td class="col-explanation">${explanationHtml}</td>
                `;
                tbody.appendChild(row);
            });

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const stats = calculateStatistics(results);

            // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            const statCards = [
                { label: 'æ€»äººæ•°', value: stats.totalPeople },
                { label: 'å¹³å‡å¾—åˆ†', value: stats.averageScore.toFixed(1) + 'åˆ†' },
                { label: 'æœ€é«˜åˆ†', value: stats.maxScore + 'åˆ†' },
                { label: 'æœ€ä½åˆ†', value: stats.minScore + 'åˆ†' },
                { label: 'Sçº§äººæ•°', value: stats.gradeDistribution.S + 'äºº' },
                { label: 'éœ€æ ¸å®äººå¤©', value: stats.needsReviewCount + 'äºº' }
            ];

            statCards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'stat-card';
                cardDiv.innerHTML = `
                    <div class="stat-value">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                `;
                statsGrid.appendChild(cardDiv);
            });

            // ä¿å­˜ç»“æœç”¨äºå¯¼å‡º
            window.currentResults = results;

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        function calculateStatistics(results) {
            const totalPeople = results.length;
            const scores = results.map(r => r.comprehensive_score);
            const averageScore = scores.reduce((a, b) => a + b, 0) / totalPeople;
            const maxScore = Math.max(...scores);
            const minScore = Math.min(...scores);

            const gradeDistribution = { S: 0, A: 0, B: 0, C: 0, D: 0 };
            results.forEach(r => {
                gradeDistribution[r.grade]++;
            });

            const needsReviewCount = results.filter(r => r.needs_review).length;

            return {
                totalPeople,
                averageScore,
                maxScore,
                minScore,
                gradeDistribution,
                needsReviewCount
            };
        }

        // å¯¼å‡ºCSV
        function exportToCSV() {
            if (!window.currentResults || window.currentResults.length === 0) {
                showError('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const results = window.currentResults;
            const headers = ['æ’å', 'å§“å', 'é€¾æœŸæ¯”ä¾‹', 'é€¾æœŸå¤©æ•°', 'å·¥ä½œäººå¤©', 'ç»¼åˆå¾—åˆ†', 'ç­‰çº§', 'è¯´æ˜'];

            const csvContent = [
                headers.join(','),
                ...results.map((result, index) => [
                    index + 1,
                    result.name,
                    result.overdue_ratio.toFixed(1) + '%',
                    result.overdue_days.toFixed(1) + 'å¤©',
                    result.work_days.toFixed(1) + 'äººå¤©',
                    result.comprehensive_score,
                    result.grade,
                    `"${result.explanation}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å›¢é˜Ÿæ•ˆèƒ½è¯„åˆ†_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess('CSVæ–‡ä»¶å·²å¯¼å‡º');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ æ”¯æŒ
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                console.log('æ–‡ä»¶ä¸Šä¼ APIæ”¯æŒ');
            } else {
                showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½');
            }
        });
    </script>
</body>
</html>